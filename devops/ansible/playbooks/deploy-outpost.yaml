---
# Deploy ImageNode to Outposts
# This playbook deploys ImageNode service to outpost nodes including:
# - Base system provisioning (users, directories, Python environment)
# - Application code deployment (from repository via sentinelcam_base)
# - Configuration file updates
# - SystemD service management
#
# Usage:
#   Full setup:     ansible-playbook playbooks/deploy-outpost.yaml
#   Code only:      ansible-playbook playbooks/deploy-outpost.yaml --tags deploy
#   Config only:    ansible-playbook playbooks/deploy-outpost.yaml --tags config

- name: Deploy ImageNode to outposts
  hosts: outposts
  become: yes
  serial: 1  # One at a time for complete setup

  pre_tasks:
    - name: Display setup target
      debug:
        msg: "Setting up outpost {{ inventory_hostname }} ({{ node_name }})"
  roles:
    - sentinelcam_base
    - imagenode

  post_tasks:
    - name: Verify all services are running
      systemd:
        name: "{{ imagenode_service }}"
      register: service_status

    - name: Display final status
      debug:
        msg: |
          Outpost {{ inventory_hostname }} setup complete:
          - Node name: {{ node_name }}
          - Accelerator: {{ imagenode_accelerator_type }}
          - Service status: {{ service_status.status.ActiveState }}
