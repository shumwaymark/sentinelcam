---
# Bootstrap playbook for fresh OS installations
# Run this after initial SSH access is established but before network deployment
#
# Usage:
#   ansible-playbook -i inventory/bootstrap.yaml \
#     playbooks/bootstrap_new_node.yaml \
#     --extra-vars "target_hostname=north target_ip=192.168.10.23 target_role=outpost"

- name: Bootstrap new SentinelCam node
  hosts: new_nodes
  become: yes
  gather_facts: yes

  vars:
    # These should be provided via extra-vars or inventory
    node_hostname: "{{ target_hostname | default(inventory_hostname) }}"
    node_timezone: "{{ target_timezone | default('America/Chicago') }}"
    node_locale: "{{ target_locale | default('en_US.UTF-8') }}"
    node_role: "{{ target_role | default('outpost') }}"

  tasks:
    # System Configuration
    - name: Set hostname
      hostname:
        name: "{{ node_hostname }}"

    - name: Update /etc/hosts with new hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1       {{ node_hostname }}"

    - name: Set timezone
      timezone:
        name: "{{ node_timezone }}"

    - name: Generate and set locale
      locale_gen:
        name: "{{ node_locale }}"
        state: present

    # System Updates
    - name: Stop PackageKit service (prevents apt lock conflicts)
      systemd:
        name: packagekit
        state: stopped
      ignore_errors: yes

    - name: Disable PackageKit service (not needed for kiosk nodes)
      systemd:
        name: packagekit
        enabled: no
      ignore_errors: yes
      when: node_role in ['watchtower']

    - name: Wait for any remaining dpkg locks to clear
      shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done
      changed_when: false
      timeout: 300

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      retries: 5
      delay: 10
      register: apt_update_result
      until: apt_update_result is succeeded

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
      retries: 3
      delay: 10
      register: upgrade_result
      until: upgrade_result is succeeded

    - name: Display upgrade summary
      debug:
        msg: "System packages upgraded. {{ upgrade_result.changed | ternary('Reboot may be required.', 'System up to date.') }}"

    # Essential Packages
    - name: Install essential system packages
      apt:
        name:
          - curl
          - wget
          - htop
          - vim
          - rsync
          - net-tools
        state: present

    # Hardware-specific packages for camera nodes
    - name: Install camera dependencies (Bookworm+ only)
      apt:
        name:
          - python3-picamera2
        state: present
      when:
        - node_role in ['outpost']
        - ansible_distribution_version is version('11', '>=')

    # User and Group Management
    - name: Set up SSH directory for ops user
      file:
        path: /home/ops/.ssh
        state: directory
        owner: ops
        group: ops
        mode: '0700'

    - name: Deploy Ansible controller's SSH key to ops user
      authorized_key:
        user: ops
        state: present
        key: "{{ lookup('file', '/home/pi/.ssh/id_rsa.pub') }}"
        comment: "ansible-controller@buzz"
      # This allows buzz (Ansible controller) to connect without password

    - name: Deploy additional SSH keys if present
      authorized_key:
        user: ops
        state: present
        key: "{{ item }}"
      loop:
        - "{{ lookup('file', '/home/pi/.ssh/id_ed25519.pub', errors='ignore') }}"
      when: item != ""
      ignore_errors: yes

    # SSH Configuration
    - name: Enable SSH service
      systemd:
        name: ssh
        enabled: yes
        state: started

    - name: Configure SSH for key-based authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication yes' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
      notify: restart ssh

    # System Configuration Files
    - name: Set up vim as default editor
      alternatives:
        name: editor
        path: /usr/bin/vim.basic
      ignore_errors: yes

  handlers:
    - name: restart ssh
      systemd:
        name: ssh
        state: restarted

  post_tasks:
    - name: Gather updated facts after configuration
      setup:

    - name: Display bootstrap completion summary
      debug:
        msg:
          - "=== Bootstrap completed for {{ node_hostname }} ==="
          - ""
          - "Configuration Summary:"
          - "  Hostname: {{ ansible_hostname }}"
          - "  OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "  Python: {{ ansible_python_version }}"
          - ""
          - "Next Steps:"
          - "  1. Run static IP configuration playbook:"
          - "     ansible-playbook -i inventory/bootstrap.yaml playbooks/configure_static_network.yaml \\"
          - "       --extra-vars 'target_hostname={{ node_hostname }} target_ip={{ target_ip }}'"
          - ""
          - "  2. Add node to production inventory (inventory/production.yaml)"
          - ""
          - "  3. Deploy services based on role:"
          - "     - Outpost: playbooks/deploy-outpost.yaml"
          - "     - Datasink: playbooks/deploy-{camwatcher,datapump,imagehub}.yaml"
          - "     - AI Processing: playbooks/deploy-sentinel.yaml"
          - "     - Watchtower: playbooks/deploy-watchtower.yaml"
          - ""
          - "For complete guide, see: devops/docs/ADD_NEW_NODE.md"
