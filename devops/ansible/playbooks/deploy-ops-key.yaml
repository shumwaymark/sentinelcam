---
# Setup SSH Key Distribution to all target nodes for primary data sink repository access
#
# This playbook configures SSH key authentication from all target nodes
# to the primary data sink to enable direct code pulls via rsync.
#
# Usage:
#   ansible-playbook playbooks/deploy-ops-key.yaml
#   ansible-playbook playbooks/deploy-ops-key.yaml --limit alpha5

- name: Generate deployment key on ansible controller
  hosts: localhost
  gather_facts: false
  connection: local
  
  tasks:
    - name: Ensure controller .ssh directory exists
      ansible.builtin.file:
        path: "~/.ssh"
        state: directory
        mode: '0700'
    
    - name: Generate ed25519 SSH key pair if not exists
      community.crypto.openssh_keypair:
        path: "~/.ssh/sentinelcam_deploy"
        type: ed25519
        comment: "sentinelcam-deployment-key"
        state: present
      register: keypair_result
    
    - name: Read private key
      ansible.builtin.slurp:
        src: "~/.ssh/sentinelcam_deploy"
      register: private_key_content
      no_log: true
    
    - name: Read public key
      ansible.builtin.slurp:
        src: "~/.ssh/sentinelcam_deploy.pub"
      register: public_key_content
    
    - name: Display keys for vault storage
      ansible.builtin.debug:
        msg:
          - "=== SAVE THESE TO ANSIBLE VAULT ==="
          - "vault_deploy_private_key: |"
          - "{{ (private_key_content['content'] | b64decode).split('\n') | map('regex_replace', '^(.*)$', '  \\1') | join('\n') }}"
          - ""
          - "vault_deploy_public_key: {{ public_key_content['content'] | b64decode | trim }}"
          - ""
          - "=== ADD THIS TO REPOSITORY authorized_keys ==="
          - "{{ public_key_content['content'] | b64decode | trim }}"
        when: keypair_result.changed
    
    - name: Store keys as facts for next play
      ansible.builtin.set_fact:
        deploy_private_key: "{{ private_key_content['content'] | b64decode }}"
        deploy_public_key: "{{ public_key_content['content'] | b64decode | trim }}"
        cacheable: false


# Deploy key to repository (data1)
- name: Add deployment key to repository authorized_keys
  hosts: primary_datasink
  gather_facts: false
  become: false
  
  vars:
    deploy_key: "{{ hostvars['localhost']['deploy_public_key'] }}"
  
  tasks:
    - name: Ensure .ssh directory exists on repository
      ansible.builtin.file:
        path: "~/.ssh"
        state: directory
        mode: '0700'
    
    - name: Add deployment key to authorized_keys
      ansible.builtin.authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ deploy_key }}"
        state: present
        comment: "SentinelCam deployment key"


# Deploy private key to all target nodes
- name: Deploy private key to target nodes for repository access
  hosts: sentinelcam_nodes:!primary_datasink
  gather_facts: false
  become: false
  
  vars:
    deploy_private_key: "{{ hostvars['localhost']['deploy_private_key'] }}"
    deploy_public_key: "{{ hostvars['localhost']['deploy_public_key'] }}"
    repo_hostname: "{{ primary_datasink }}"
    repo_user: "{{ sentinelcam_user }}"
  
  tasks:
    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "~/.ssh"
        state: directory
        mode: '0700'
    
    - name: Deploy private key for repository access
      ansible.builtin.copy:
        content: "{{ deploy_private_key }}"
        dest: "~/.ssh/sentinelcam_deploy"
        mode: '0600'
      no_log: true
    
    - name: Add repository to known_hosts
      ansible.builtin.known_hosts:
        name: "{{ repo_hostname }}"
        key: "{{ lookup('pipe', 'ssh-keyscan -H ' + repo_hostname + ' 2>/dev/null') }}"
        state: present
    
    - name: Configure SSH for repository access
      ansible.builtin.blockinfile:
        path: "~/.ssh/config"
        create: true
        mode: '0600'
        marker: "# {mark} ANSIBLE MANAGED - Repository Access"
        block: |
          Host sentinelcam-repo {{ repo_hostname }}
            HostName {{ repo_hostname }}
            User {{ repo_user }}
            IdentityFile ~/.ssh/sentinelcam_deploy
            StrictHostKeyChecking accept-new


# Verify connectivity both ways
- name: Verify controller → all nodes (existing Ansible access)
  hosts: sentinelcam_nodes
  gather_facts: false
  
  tasks:
    - name: Ping test
      ansible.builtin.ping:
      register: ping_result
    
    - name: Report controller access
      ansible.builtin.debug:
        msg: "Controller → {{ inventory_hostname }}: OK"


- name: Verify targets → repository access
  hosts: sentinelcam_nodes:!primary_datasink
  gather_facts: false
  
  vars:
    repo_hostname: "{{ primary_datasink }}"
    repo_user: "{{ sentinelcam_user }}"
  
  tasks:
    - name: Test SSH to repository
      ansible.builtin.command:
        cmd: "ssh -i ~/.ssh/sentinelcam_deploy -o BatchMode=yes {{ repo_user }}@{{ repo_hostname }} 'echo Success'"
      register: ssh_test
      changed_when: false
      failed_when: false
    
    - name: Report repository access
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} → Repository: {{ 'OK' if ssh_test.rc == 0 else 'FAILED' }}"
    
    - name: Fail if repository unreachable
      ansible.builtin.fail:
        msg: "Cannot reach repository from {{ inventory_hostname }}"
      when: ssh_test.rc != 0
