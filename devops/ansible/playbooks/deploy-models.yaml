---
# Model Deployment Playbook
#
# Deploys versioned ML models from the model registry (on primary_datasink)
# to sentinel and imagenode hosts. Models are pulled directly from the
# repository by each target node.
#
# Models are deployed independently from code, allowing version changes
# via configuration updates only (no model file redeployment needed for rollback).
#
# Usage:
#   # Deploy all models to all nodes
#   ansible-playbook playbooks/deploy-models.yaml
#
#   # Deploy specific model(s)
#   ansible-playbook playbooks/deploy-models.yaml --tags=face_recognition
#
#   # Deploy to specific host
#   ansible-playbook playbooks/deploy-models.yaml --limit=sentinel1
#
#   # Deploy only to sentinels
#   ansible-playbook playbooks/deploy-models.yaml --limit=sentinels
#
# Model Selection:
#   - Sentinels: All required models deployed
#   - Outposts: Filtered by outpost_models list (default: mobilenet_ssd)
#   - Versions: From model_registry.yaml current_version
#   - Override: Per-host via model_version_overrides in host_vars

- name: "Pre-deployment validation on primary datasink"
  hosts: primary_datasink
  gather_facts: no
  tags: always
  tasks:
    - name: "Verify model registry exists"
      ansible.builtin.stat:
        path: "{{ sentinelcam_model_registry }}"
      register: registry_check
      failed_when: not registry_check.stat.exists

    - name: "Verify model versions exist in registry"
      ansible.builtin.stat:
        path: "{{ sentinelcam_model_registry }}/{{ item.key }}/{{ item.value.current_version }}"
      loop: "{{ sentinelcam_models | dict2items }}"
      loop_control:
        label: "{{ item.key }}/{{ item.value.current_version }}"
      register: version_check
      failed_when: not version_check.stat.exists

- name: "Deploy models to sentinel nodes"
  hosts: sentinels
  become: yes
  tags: sentinels
  roles:
    - sentinel
  vars:
    repo_user: "{{ hostvars[primary_datasink]['ansible_user'] }}"
    repo_ip: "{{ hostvars[primary_datasink]['ansible_host'] }}"

  tasks:
    - name: "Ensure sentinel models directory exists"
      ansible.builtin.file:
        path: "{{ sentinel_models_path }}"
        state: directory
        owner: "{{ sentinelcam_user }}"
        group: "{{ sentinelcam_group }}"
        mode: '0755'

    - name: "Ensure version directory exists for each model"
      ansible.builtin.file:
        path: "{{ sentinel_models_path }}/{{ item }}/{{ model_version_overrides[item] | default(sentinelcam_models[item].current_version) }}"
        state: directory
        owner: "{{ sentinelcam_user }}"
        group: "{{ sentinelcam_group }}"
        mode: '0755'
      loop: "{{ sentinelcam_models.keys() }}"

    - name: "Deploy MobileNet SSD model to sentinel"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/mobilenet_ssd/{{ model_version_overrides.mobilenet_ssd | default(sentinelcam_models.mobilenet_ssd.current_version) }}/
          {{ sentinel_models_path }}/mobilenet_ssd/{{ model_version_overrides.mobilenet_ssd | default(sentinelcam_models.mobilenet_ssd.current_version) }}/
      become: false
      register: mobilenet_sync
      changed_when: mobilenet_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: mobilenet_ssd

    - name: "Deploy MobileNet SSD EdgeTPU model to sentinel"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/mobilenet_ssd_edgetpu/{{ model_version_overrides.mobilenet_ssd_edgetpu | default(sentinelcam_models.mobilenet_ssd_edgetpu.current_version) }}/
          {{ sentinel_models_path }}/mobilenet_ssd_edgetpu/{{ model_version_overrides.mobilenet_ssd_edgetpu | default(sentinelcam_models.mobilenet_ssd_edgetpu.current_version) }}/
      become: false
      register: mobilenet_sync
      changed_when: mobilenet_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: mobilenet_ssd

    - name: "Deploy face detection model to sentinel"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/face_detection/{{ model_version_overrides.face_detection | default(sentinelcam_models.face_detection.current_version) }}/
          {{ sentinel_models_path }}/face_detection/{{ model_version_overrides.face_detection | default(sentinelcam_models.face_detection.current_version) }}/
      become: false
      register: face_detection_sync
      changed_when: face_detection_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: face_detection

    - name: "Deploy face detection EdgeTPU model to sentinel"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/face_detection_edgetpu/{{ model_version_overrides.face_detection_edgetpu | default(sentinelcam_models.face_detection_edgetpu.current_version) }}/
          {{ sentinel_models_path }}/face_detection_edgetpu/{{ model_version_overrides.face_detection_edgetpu | default(sentinelcam_models.face_detection_edgetpu.current_version) }}/
      become: false
      register: face_detection_sync
      changed_when: face_detection_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: face_detection

    - name: "Deploy BlazeFace EdgeTPU model to sentinel"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/face_detection_blazeface/{{ model_version_overrides.face_detection_blazeface | default(sentinelcam_models.face_detection_blazeface.current_version) }}/
          {{ sentinel_models_path }}/face_detection_blazeface/{{ model_version_overrides.face_detection_blazeface | default(sentinelcam_models.face_detection_blazeface.current_version) }}/
      become: false
      register: blazeface_sync
      changed_when: blazeface_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags:
        - face_detection
        - blazeface

    - name: "Deploy face recognition model files to sentinel"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          --exclude=facelist.csv --exclude=facedata.hdf5
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/face_recognition/{{ model_version_overrides.face_recognition | default(sentinelcam_models.face_recognition.current_version) }}/
          {{ sentinel_models_path }}/face_recognition/{{ model_version_overrides.face_recognition | default(sentinelcam_models.face_recognition.current_version) }}/
      become: false
      register: face_recognition_sync
      changed_when: face_recognition_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: face_recognition

    - name: "Check if facelist.csv already exists on sentinel"
      ansible.builtin.stat:
        path: "{{ sentinel_models_path }}/face_recognition/{{ model_version_overrides.face_recognition | default(sentinelcam_models.face_recognition.current_version) }}/facelist.csv"
      register: facelist_exists
      tags: face_recognition

    - name: "Check if facedata.hdf5 already exists on sentinel"
      ansible.builtin.stat:
        path: "{{ sentinel_models_path }}/face_recognition/{{ model_version_overrides.face_recognition | default(sentinelcam_models.face_recognition.current_version) }}/facedata.hdf5"
      register: facedata_exists
      tags: face_recognition

    - name: "Deploy initial facelist.csv to new sentinel (initial provisioning only)"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/face_recognition/{{ model_version_overrides.face_recognition | default(sentinelcam_models.face_recognition.current_version) }}/facelist.csv
          {{ sentinel_models_path }}/face_recognition/{{ model_version_overrides.face_recognition | default(sentinelcam_models.face_recognition.current_version) }}/facelist.csv
      become: false
      when: not facelist_exists.stat.exists
      register: facelist_initial_sync
      changed_when: facelist_initial_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: face_recognition

    - name: "Deploy initial facedata.hdf5 to new sentinel (initial provisioning only)"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/face_recognition/{{ model_version_overrides.face_recognition | default(sentinelcam_models.face_recognition.current_version) }}/facedata.hdf5
          {{ sentinel_models_path }}/face_recognition/{{ model_version_overrides.face_recognition | default(sentinelcam_models.face_recognition.current_version) }}/facedata.hdf5
      become: false
      when: not facedata_exists.stat.exists
      register: facedata_initial_sync
      changed_when: facedata_initial_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: face_recognition

    - name: "Deploy haarcascades model to sentinel"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/haarcascades/{{ model_version_overrides.haarcascades | default(sentinelcam_models.haarcascades.current_version) }}/
          {{ sentinel_models_path }}/haarcascades/{{ model_version_overrides.haarcascades | default(sentinelcam_models.haarcascades.current_version) }}/
      become: false
      register: haarcascades_sync
      changed_when: haarcascades_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: haarcascades

    - name: "Deploy openface torch model to sentinel"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/openface_torch/{{ model_version_overrides.openface_torch | default(sentinelcam_models.openface_torch.current_version) }}/
          {{ sentinel_models_path }}/openface_torch/{{ model_version_overrides.openface_torch | default(sentinelcam_models.openface_torch.current_version) }}/
      become: false
      register: openface_sync
      changed_when: openface_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: openface_torch

- name: "Deploy models to outpost (imagenode) nodes"
  hosts: outposts
  become: yes
  tags: outposts
  roles:
    - imagenode
  vars:
    repo_user: "{{ hostvars[primary_datasink]['ansible_user'] }}"
    repo_ip: "{{ hostvars[primary_datasink]['ansible_host'] }}"

  tasks:
    - name: "Ensure imagenode models directory exists"
      ansible.builtin.file:
        path: "{{ imagenode_models_path }}"
        state: directory
        owner: "{{ sentinelcam_user }}"
        group: "{{ sentinelcam_group }}"
        mode: '0755'

    - name: "Ensure model version directory exists for each outpost model"
      ansible.builtin.file:
        path: "{{ imagenode_models_path }}/{{ item }}/{{ model_version_overrides[item] | default(sentinelcam_models[item].current_version) }}"
        state: directory
        owner: "{{ sentinelcam_user }}"
        group: "{{ sentinelcam_group }}"
        mode: '0755'
      loop: "{{ outpost_models }}"
      tags: outpost_models

    - name: "Deploy models to outpost based on outpost_models list"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/{{ item }}/{{ model_version_overrides[item] | default(sentinelcam_models[item].current_version) }}/
          {{ imagenode_models_path }}/{{ item }}/{{ model_version_overrides[item] | default(sentinelcam_models[item].current_version) }}/
      loop: "{{ outpost_models }}"
      become: false
      register: outpost_sync
      changed_when: outpost_sync.stdout is search('Number of .*files transferred.*[1-9]')
      tags: outpost_models

- name: "Deploy face recognition linked files to datasinks"
  hosts: datasinks
  become: yes
  tags:
    - datasinks
    - face_recognition

  vars:
    repo_user: "{{ hostvars[primary_datasink]['ansible_user'] }}"
    repo_ip: "{{ hostvars[primary_datasink]['ansible_host'] }}"

  tasks:
    - name: "Skip primary datasink (this is the repository host)"
      ansible.builtin.meta: end_host
      when: inventory_hostname == primary_datasink

    - name: "Ensure datasink face_recognition directory exists"
      ansible.builtin.file:
        path: "{{ sentinelcam_data_path }}/face_recognition"
        state: directory
        owner: "{{ sentinelcam_user }}"
        group: "{{ sentinelcam_group }}"
        mode: '0755'

    - name: "Deploy facelist.csv to datasink"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/face_recognition/{{ sentinelcam_models.face_recognition.current_version }}/facelist.csv
          {{ sentinelcam_data_path }}/face_recognition/facelist_{{ sentinelcam_models.face_recognition.current_version }}.csv
      become: false
      register: facelist_sync
      changed_when: facelist_sync.stdout is search('Number of .*files transferred.*[1-9]')

    - name: "Create symlink for current facelist"
      ansible.builtin.file:
        src: "{{ sentinelcam_data_path }}/face_recognition/facelist_{{ sentinelcam_models.face_recognition.current_version }}.csv"
        dest: "{{ sentinelcam_data_path }}/face_recognition/facelist_current.csv"
        state: link
        owner: "{{ sentinelcam_user }}"
        group: "{{ sentinelcam_group }}"

    - name: "Deploy facedata.hdf5 to datasink"
      ansible.builtin.command:
        cmd: >
          rsync -avz --update --checksum
          {{ repo_user }}@{{ repo_ip }}:{{ sentinelcam_model_registry }}/face_recognition/{{ sentinelcam_models.face_recognition.current_version }}/facedata.hdf5
          {{ sentinelcam_data_path }}/face_recognition/facedata_{{ sentinelcam_models.face_recognition.current_version }}.hdf5
      register: facedata_sync
      changed_when: facedata_sync.stdout is search('Number of .*files transferred.*[1-9]')
      become: false
