# Setup SSH Key Distribution to primary data sink for all target Nodes
#
# This playbook configures SSH key authentication from all target nodes
# to the primary data sink to enable direct code pulls via rsync.
#
# Usage:
#   ansible-playbook playbooks/deploy-ssh-key.yaml
#   ansible-playbook playbooks/deploy-ssh-key.yaml --limit <target_node>
#   ansible-playbook playbooks/deploy-ssh-key.yaml --limit ml_trainers

- name: Deploy repository access key to all nodes
  hosts: sentinelcam_nodes:ml_trainers
  gather_facts: false
  become: false

  vars:
    # private key should be in ansible-vault
    repo_deploy_private_key: "{{ vault_ssh_private_key }}"
    repo_hostname: "{{ primary_datasink }}"
    repo_ip_address: "{{ hostvars[primary_datasink]['ansible_host'] }}"
    repo_user: "{{ hostvars[primary_datasink]['ansible_user'] }}"

  tasks:
    - name: Skip if this is the primary data sink
      ansible.builtin.meta: end_host
      when: inventory_hostname == primary_datasink

    - name: Display target node info
      ansible.builtin.debug:
        msg:
          - "Configuring: {{ inventory_hostname }}"
          - "User: {{ ansible_user }}"
          - "For repository: {{ repo_hostname }} ({{ repo_ip_address }}) as user {{ repo_user }}"

    - name: Ensure SSH directory exists
      ansible.builtin.file:
        path: "~/.ssh"
        state: directory
        mode: '0700'

    - name: Deploy repository deployment key
      ansible.builtin.copy:
        content: "{{ repo_deploy_private_key }}"
        dest: "~/.ssh/sentinelcam_deploy_key"
        mode: '0600'
        owner: "{{ ansible_user }}"
      no_log: true  # Don't log the private key

    - name: Configure SSH to use deployment key for repository
      ansible.builtin.blockinfile:
        path: "~/.ssh/config"
        create: true
        mode: '0600'
        marker: "# {mark} ANSIBLE MANAGED - Repository Access"
        block: |
          Host {{ repo_hostname }} {{ repo_ip_address }} repo
            HostName {{ repo_ip_address }}
            User {{ repo_user }}
            IdentityFile ~/.ssh/sentinelcam_deploy_key
            StrictHostKeyChecking accept-new
            ServerAliveInterval 60

# Deploy key to primary data sink authorized_keys
- name: Add deployment key to primary data sink authorized_keys
  hosts: sentinelcam_nodes:ml_trainers
  gather_facts: false
  become: false

  vars:
    deploy_key: "{{ vault_ssh_public_key }}"

  tasks:
    - name: Skip if this is not the primary data sink
      ansible.builtin.meta: end_host
      when: inventory_hostname != primary_datasink

    - name: Ensure .ssh directory exists on repository
      ansible.builtin.file:
        path: "~/.ssh"
        state: directory
        mode: '0700'

    - name: Add deployment key to authorized_keys
      ansible.builtin.authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ deploy_key }}"
        state: present
        comment: "SentinelCam deployment key"


- name: Verify repository connectivity from all nodes
  hosts: sentinelcam_nodes:ml_trainers
  gather_facts: false
  become: false

  vars:
    repo_hostname: "{{ primary_datasink }}"
    repo_ip_address: "{{ hostvars[primary_datasink]['ansible_host'] }}"
    repo_user: "{{ hostvars[primary_datasink]['ansible_user'] }}"

  tasks:
    - name: Test SSH connection to repository
      ansible.builtin.command:
        cmd: "ssh -o BatchMode=yes {{ repo_user }}@{{ repo_hostname }} 'echo Success'"
      register: ssh_test_result
      changed_when: false
      failed_when: false

    - name: Display connectivity test result
      ansible.builtin.debug:
        msg:
          - "Node: {{ inventory_hostname }}"
          - "Repository: {{ repo_hostname }}"
          - "Result: {{ 'SUCCESS' if ssh_test_result.rc == 0 else 'FAILED' }}"
          - "Output: {{ ssh_test_result.stdout if ssh_test_result.rc == 0 else ssh_test_result.stderr }}"

    - name: Test rsync access (dry-run)
      ansible.builtin.command:
        cmd: "rsync -avzn {{ repo_user }}@{{ repo_hostname }}:/etc/hosts /tmp/rsync-test"
      register: rsync_test_result
      changed_when: false
      failed_when: false

    - name: Display rsync test result
      ansible.builtin.debug:
        msg:
          - "Rsync test: {{ 'SUCCESS' if rsync_test_result.rc == 0 else 'FAILED' }}"
          - "{{ rsync_test_result.stdout_lines[:5] | default(['No output']) }}"

    - name: Fail if connectivity verification failed
      ansible.builtin.fail:
        msg: "Repository connectivity verification failed for {{ inventory_hostname }}"
      when: ssh_test_result.rc != 0 or rsync_test_result.rc != 0
