#!/bin/bash
# Deploy trained model to target nodes
# Generated by Ansible template
# Usage: deploy_model.sh <model_version>
#   e.g., deploy_model.sh facemodel_gamma3

set -e

if [ $# -ne 1 ]; then
  echo "Usage: $0 <model_version>"
  echo "Example: $0 facemodel_gamma3"
  exit 1
fi

MODEL_VERSION="$1"
MODELS_DIR="{{ deepthink_models_path }}"
ANSIBLE_DIR="{{ sentinelcam_deployment_source }}/devops/ansible"

# Validate model files exist
MODEL_FILE="${MODELS_DIR}/${MODEL_VERSION}.pickle"
BASELINES_FILE="${MODELS_DIR}/baselines_${MODEL_VERSION#facemodel_}.hdf5"
FACELIST_FILE="{{ deepthink_data_path }}/facelist_${MODEL_VERSION#facemodel_}.csv"

if [ ! -f "$MODEL_FILE" ]; then
  echo "Error: Model file not found: $MODEL_FILE"
  exit 1
fi

if [ ! -f "$BASELINES_FILE" ]; then
  echo "Warning: Baselines file not found: $BASELINES_FILE (continuing anyway)"
fi

if [ ! -f "$FACELIST_FILE" ]; then
  echo "Warning: Facelist file not found: $FACELIST_FILE (continuing anyway)"
fi

echo "Deploying model: $MODEL_VERSION"
echo "Model file: $MODEL_FILE"
echo "Baselines file: $BASELINES_FILE"
echo "Facelist file: $FACELIST_FILE"
echo ""

# Deploy to sentinels
echo "Deploying to sentinels..."
{% for sentinel in deepthink_deployment_targets.face_model.sentinels %}
scp "$MODEL_FILE" {{ sentinelcam_user }}@{{ hostvars[sentinel].ansible_host }}:{{ hostvars[sentinel].sentinel_install_path | default('/home/' + sentinelcam_user + '/sentinel') }}/models/
[ -f "$BASELINES_FILE" ] && scp "$BASELINES_FILE" {{ sentinelcam_user }}@{{ hostvars[sentinel].ansible_host }}:{{ hostvars[sentinel].sentinel_install_path | default('/home/' + sentinelcam_user + '/sentinel') }}/models/
{% endfor %}

# Deploy facelist.csv to datasinks
echo "Deploying facelist to datasinks..."
{% for datasink in deepthink_deployment_targets.face_model.datasinks %}
[ -f "$FACELIST_FILE" ] && scp "$FACELIST_FILE" {{ sentinelcam_user }}@{{ hostvars[datasink].ansible_host }}:{{ sentinelcam_directories.faces }}/
{% endfor %}

echo ""
echo "Deployment complete!"
echo "Remember to restart services to use the new model:"
echo "  ansible sentinels -a 'systemctl restart sentinel'"
