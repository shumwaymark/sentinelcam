#!/bin/bash
# Upload and Deploy Trained Model to Registry
#
# This script is executed on the DeepThink training node after successful
# model training. It packages the trained model, generates a manifest with
# checksums, uploads to the model registry, updates the registry configuration,
# and triggers deployment.
#
# Generated by Ansible template for {{ inventory_hostname }}
#
# Usage: ./upload_and_deploy.sh <model_name> <model_version> <model_files...>
#   model_name: Name of the model type (e.g., face_recognition)
#   model_version: YYYY-MM-DD timestamp
#   model_files: Space-separated list of model files to upload
#
# Example:
#   ./upload_and_deploy.sh face_recognition 2025-12-08 \
#       facemodel.pickle baselines.hdf5 facelist.csv facedata.hdf5

set -e
set -o pipefail

# Configuration
REGISTRY_HOST="{{ primary_datasink }}"
REGISTRY_PATH="{{ sentinelcam_model_registry }}"
#ANSIBLE_CONTROL="{{ groups['ansible_control'][0] | default('localhost') }}"
ANSIBLE_DIR="{{ sentinelcam_data_path }}/devops/ansible"
MODELS_DIR="{{ deepthink_models_path }}"
LOG_FILE="model_deployment.log"

# Logging function
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Validation
if [ $# -lt 3 ]; then
    echo "Usage: $0 <model_name> <model_version> <model_files...>"
    echo "Example: $0 face_recognition 2025-12-08 facemodel.pickle baselines.hdf5 facelist.csv facedata.hdf5"
    exit 1
fi

MODEL_NAME="$1"
MODEL_VERSION="$2"
shift 2
MODEL_FILES=("$@")

log "===== Starting model upload and deployment ====="
log "Model: ${MODEL_NAME}"
log "Version: ${MODEL_VERSION}"
log "Files: ${MODEL_FILES[*]}"

# Validate model files exist
for file in "${MODEL_FILES[@]}"; do
    if [ ! -f "${MODELS_DIR}/${file}" ]; then
        log "ERROR: Model file not found: ${MODELS_DIR}/${file}"
        exit 1
    fi
done

# Create temporary staging directory
STAGING_DIR=$(mktemp -d)
trap 'rm -rf "$STAGING_DIR"' EXIT

log "Staging directory: ${STAGING_DIR}"

# Copy model files to staging
for file in "${MODEL_FILES[@]}"; do
    cp "${MODELS_DIR}/${file}" "${STAGING_DIR}/"
done

# Generate SHA256 checksums
log "Calculating checksums..."
MANIFEST_FILE="${STAGING_DIR}/manifest.yaml"

cat > "$MANIFEST_FILE" << EOF
%YAML 1.0
---
# Model Manifest
# Generated on $(date -u +'%Y-%m-%d %H:%M:%S UTC')
# Training node: $(hostname)

name: ${MODEL_NAME}
version: ${MODEL_VERSION}
framework: {% if MODEL_NAME == 'face_recognition' %}pickle{% else %}unknown{% endif %}
source: deepthink_training
date_deployed: $(date -u +'%Y-%m-%d')

# Training metrics (placeholder)
# TODO: Extract metrics from notebook execution metadata
# - Add papermill tags to notebook cells for metric capture
# - Parse notebook JSON for tagged cell outputs
# - Populate accuracy, f1_score, training_time, etc.
training_metrics:
  # Example structure:
  # accuracy: 0.95
  # f1_score: 0.93
  # precision: 0.94
  # recall: 0.92
  # training_time_seconds: 3600
  # num_samples: 1500
  # num_classes: 25
  placeholder: true

files:
EOF

cd "$STAGING_DIR"
for file in "${MODEL_FILES[@]}"; do
    checksum=$(sha256sum "$file" | awk '{print $1}')
    log "  ${file}: ${checksum}"
    echo "  - name: ${file}" >> manifest.yaml
    echo "    sha256: ${checksum}" >> manifest.yaml
done

# Get current version from registry (for previous_version field)
log "Fetching current model version from registry..."
CURRENT_VERSION=$(ssh {{ sentinelcam_user }}@${REGISTRY_HOST} \
    "grep -A1 '${MODEL_NAME}:' {{ sentinelcam_deployment_source }}/devops/ansible/inventory/group_vars/all/model_registry.yaml | grep 'current_version:' | awk '{print \$2}' | tr -d '\"'" || echo "null")

echo "" >> manifest.yaml
echo "previous_version: ${CURRENT_VERSION}" >> manifest.yaml

log "Previous version: ${CURRENT_VERSION}"

# Create version directory on registry
log "Creating registry directory..."
ssh {{ sentinelcam_user }}@${REGISTRY_HOST} \
    "mkdir -p ${REGISTRY_PATH}/${MODEL_NAME}/${MODEL_VERSION}"

# Upload model files and manifest to registry
log "Uploading model files to registry..."
scp -r "${STAGING_DIR}/"* {{ sentinelcam_user }}@${REGISTRY_HOST}:${REGISTRY_PATH}/${MODEL_NAME}/${MODEL_VERSION}/

# Update model_registry.yaml on control node
log "Updating model registry configuration..."
ssh {{ sentinelcam_user }}@${REGISTRY_HOST} << EOSSH
cd ${ANSIBLE_DIR}

# Backup current registry
cp inventory/group_vars/all/model_registry.yaml inventory/group_vars/all/model_registry.yaml.bak

# Update current_version and previous_version
sed -i '/${MODEL_NAME}:/,/previous_version:/ {
    s/current_version: .*/current_version: "${MODEL_VERSION}"/
    s/previous_version: .*/previous_version: ${CURRENT_VERSION}/
}' inventory/group_vars/all/model_registry.yaml

## Commit to git
#git add inventory/group_vars/all/model_registry.yaml
#git commit -m "Update ${MODEL_NAME} model to version ${MODEL_VERSION}" || true

EOSSH
log "Registry configuration updated"

## Trigger model deployment playbook
#log "Triggering model deployment..."
#ssh {{ sentinelcam_user }}@${ANSIBLE_CONTROL} << EOSSH
#cd ${ANSIBLE_DIR}
#ansible-playbook playbooks/deploy-models.yaml --tags=${MODEL_NAME} 2>&1 | tee -a ${LOG_FILE}
#EOSSH

log "===== Model deployment completed successfully ====="
log "Model ${MODEL_NAME} version ${MODEL_VERSION} is now deployed"
log ""
log "To rollback if needed:"
log "  devops/scripts/rollback_model.sh ${MODEL_NAME} ${CURRENT_VERSION}"

exit 0
