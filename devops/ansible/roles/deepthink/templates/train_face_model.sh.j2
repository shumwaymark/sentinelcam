#!/bin/bash
# Train face recognition model using papermill
# Uses model registry versioning (YYYY-MM-DD)
# Generated by Ansible template

set -e

VENV="{{ deepthink_venv_path }}"
NOTEBOOKS_DIR="{{ deepthink_notebooks_path }}"
MODELS_DIR="{{ deepthink_models_path }}"
DATA_DIR="{{ deepthink_data_path }}"
OUTPUT_DIR="{{ deepthink_papermill_output_path }}"
LOG_DIR="{{ sentinelcam_data_path }}/logs"

# Model version (YYYY-MM-DD format for model registry)
if [ -z "$1" ]; then
  MODEL_VERSION=$(date +%Y-%m-%d)
else
  MODEL_VERSION="$1"
fi

OUTPUT_NOTEBOOK="${OUTPUT_DIR}/facemodel_${MODEL_VERSION}.ipynb"

echo "======================================="
echo "Face Model Training"
echo "======================================="
echo "Model version: ${MODEL_VERSION}"
echo "Started: $(date)"
echo "Input notebook: ${NOTEBOOKS_DIR}/facemodel_build_beta.ipynb"
echo "Output notebook: ${OUTPUT_NOTEBOOK}"
echo "======================================="

# Activate virtual environment
source "${VENV}/bin/activate"

# Run notebook with papermill
papermill \
  "${NOTEBOOKS_DIR}/facemodel_build_beta.ipynb" \
  "${OUTPUT_NOTEBOOK}" \
  -p model_version "${MODEL_VERSION}" \
  2>&1 | tee "${LOG_DIR}/training_${MODEL_VERSION}.log"

EXIT_CODE=${PIPESTATUS[0]}

if [ $EXIT_CODE -eq 0 ]; then
  echo ""
  echo "======================================="
  echo "✓ Training completed successfully"
  echo "======================================="
  echo "Completed: $(date)"
  echo "Model files in: ${MODELS_DIR}"
  echo "  - facemodel.pickle"
  echo "  - baselines.hdf5"
  echo "  - facelist.csv (if generated)"
  echo "  - facedata.hdf5 (training data)"
  echo ""
  echo "Next step: Deploy to model registry"
  echo "  {{ deepthink_install_path }}/upload_and_deploy.sh face_recognition ${MODEL_VERSION} \\"
  echo "    facemodel.pickle baselines.hdf5 facelist.csv facedata.hdf5"
  echo "======================================="
else
  echo ""
  echo "======================================="
  echo "✗ Training failed"
  echo "======================================="
  echo "Exit code: $EXIT_CODE"
  echo "Log: ${LOG_DIR}/training_${MODEL_VERSION}.log"
  echo "======================================="
  exit $EXIT_CODE
fi
