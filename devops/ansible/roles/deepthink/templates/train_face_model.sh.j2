#!/bin/bash
# Train face recognition model using papermill
# Generated by Ansible template

set -e

VENV="{{ deepthink_venv_path }}"
NOTEBOOKS_DIR="{{ deepthink_notebooks_path }}"
MODELS_DIR="{{ deepthink_models_path }}"
DATA_DIR="{{ deepthink_data_path }}"
OUTPUT_DIR="{{ deepthink_papermill_output_path }}"

# Activate virtual environment
source "${VENV}/bin/activate"

# Generate timestamp for this training run
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_NOTEBOOK="${OUTPUT_DIR}/facemodel_gamma3_${TIMESTAMP}.ipynb"

echo "Starting face model training at $(date)"
echo "Input notebook: ${NOTEBOOKS_DIR}/facemodel_gamma3.ipynb"
echo "Output notebook: ${OUTPUT_NOTEBOOK}"

# Run notebook with papermill
papermill \
  "${NOTEBOOKS_DIR}/facemodel_gamma3.ipynb" \
  "${OUTPUT_NOTEBOOK}" \
  -p models_path "${MODELS_DIR}" \
  -p data_path "${DATA_DIR}"

EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
  echo "Training completed successfully at $(date)"
  echo "Model files saved to: ${MODELS_DIR}"
  
  # Find the generated model files
  LATEST_MODEL=$(ls -t ${MODELS_DIR}/facemodel_*.pickle 2>/dev/null | head -1)
  LATEST_BASELINES=$(ls -t ${MODELS_DIR}/baselines_*.hdf5 2>/dev/null | head -1)
  
  if [ -n "$LATEST_MODEL" ]; then
    echo "Latest model: $LATEST_MODEL"
    echo "Latest baselines: $LATEST_BASELINES"
    echo ""
    echo "To deploy this model, run:"
    echo "  {{ deepthink_install_path }}/deploy_model.sh $(basename $LATEST_MODEL .pickle)"
  fi
else
  echo "Training failed with exit code $EXIT_CODE at $(date)"
  exit $EXIT_CODE
fi
