# Settings file imagenode.yaml -- SentinelCam version 7
# Generated by Ansible for {{ inventory_hostname }}
# Node: {{ imagenode_config.node_name }}
---
node:
  name: {{ imagenode_config.node_name }}
  heartbeat: {{ imagenode_config.heartbeat | default(10) }}
  REP_watcher: False
  queuemax: 50
  send_type: jpg
  send_threading: True
  print_settings: False

{% set datasink = sentinelcam_outposts[inventory_hostname].datasink | default('data1') %}
hub_address:
  H1: tcp://{{ datasink }}:{{ sentinelcam_ports.imagehub_zmq }}

cameras:
{% for camera_id, camera in imagenode_config.cameras.items() %}
  {{ camera_id }}:
    viewname: {{ camera.viewname }}
    resolution: {{ camera.resolution | string }}
    framerate: {{ camera.framerate }}
{% if camera_id.startswith('P') %}
    vflip: {{ camera.vflip | default(false) }}
    threaded_read: {{ camera.threaded_read | default(false) }}
{% endif %}
    detectors:
        outpost:
{% if camera_id.startswith('O') and camera.detector.encoder is defined %}
            encoder: {{ camera.detector.encoder }}
{% endif %}
            publish_cam: {{ sentinelcam_ports.imagenode_publisher }}
            publish_log: {{ sentinelcam_ports.imagenode_logging }}
            logconfig:
                version: 1
                handlers:
                    zmq:
                        class: zmq.log.handlers.PUBHandler
                        interface_or_socket: tcp://*:{{ sentinelcam_ports.imagenode_logging }}
                        root_topic: {{ imagenode_config.node_name }}
                        level: {{ 'DEBUG' if (camera.debug_mode | default(debug_mode)) else 'INFO' }}
                root:
                    handlers: [zmq]
                    level: {{ 'DEBUG' if (camera.debug_mode | default(debug_mode)) else 'INFO' }}
            camwatcher: tcp://{{ datasink }}:{{ sentinelcam_ports.camwatcher_control }}
            spyglass: {{ camera.resolution | string }}
            detectobjects: {{ camera.detector.detectobjects | default('none') }}
            accelerator: {{ camera.detector.accelerator | default('none') }}
            tracker: none
{% if camera.detector.depthai is defined %}
            depthai:
               pipeline: {{ camera.detector.depthai.pipeline }}
               images: {{ camera.detector.depthai.images }}
               jpegs: {{ camera.detector.depthai.jpegs }}
               neural_nets:
{% for nn_id, nn_queue in camera.detector.depthai.neural_nets.items() %}
                  {{ nn_id }}: {{ nn_queue }}
{% endfor %}
{% endif %}
{% if camera.detector.sentinel_tasks is defined %}
            sentinel_tasks:
{% for detection, task in camera.detector.sentinel_tasks.items() %}
                {{ detection }}: {{ task }}
{% endfor %}
{% endif %}
{% if camera.detector.detectobjects == 'mobilenetssd' %}
            mobilenetssd:
                prototxt_path: {{ mobilenet_prototxt }}
                model_path: {{ mobilenet_model }}
                confidence: {{ mobilenet_confidence }}
                target: {% if camera.detector.accelerator == 'ncs2' %}myriad{% else %}cpu{% endif %}

{% endif %}
{% endfor %}
