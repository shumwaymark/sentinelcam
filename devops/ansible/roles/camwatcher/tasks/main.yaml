---
# SentinelCam CamWatcher Role - Main Tasks
#
# Responsibilities:
# - User/group creation (if needed)
# - Directory structure setup
# - Systemd service file deployment (template)
# - Configuration file deployment (template)
# - Service enable/start
#
# Code deployment is handled by deploy.yaml (included below)
# Uses watchtower pattern: no duplication between main.yaml and deploy.yaml

- name: "Include deployment tasks"
  ansible.builtin.include_tasks: deploy.yaml
  tags:
    - deploy
    - deployment
    - status
    - health

- name: "Create CamWatcher installation directory"
  ansible.builtin.file:
    path: "{{ camwatcher_install_path }}"
    state: directory
    owner: "{{ sentinelcam_user }}"
    group: "{{ sentinelcam_group }}"
    mode: '0755'
  tags: directories

- name: "Ensure CamWatcher-specific data directories exist"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ sentinelcam_user }}"
    group: "{{ sentinelcam_group }}"
    mode: '0755'
  loop:
    - "{{ sentinelcam_directories.csvfiles }}"
    - "{{ sentinelcam_directories.images }}"
  tags: directories

- name: "Deploy CamWatcher systemd service file"
  ansible.builtin.template:
    src: camwatcher.service.j2
    dest: /etc/systemd/system/{{ camwatcher_service }}.service
    mode: '0644'
    backup: yes
  notify:
    - reload systemd
  tags: service

- name: "Deploy CamWatcher configuration file"
  ansible.builtin.template:
    src: camwatcher.yaml.j2
    dest: "{{ camwatcher_config_path }}"
    owner: "{{ sentinelcam_user }}"
    group: "{{ sentinelcam_group }}"
    mode: '0644'
    backup: yes
  notify:
    - restart camwatcher
  tags: config
