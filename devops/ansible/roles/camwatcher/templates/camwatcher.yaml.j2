%YAML 1.0
---
# Settings file camwatcher.yaml
# Generated by Ansible template

control_port: {{ sentinelcam_ports.camwatcher_control }}
datapump_port: {{ sentinelcam_ports.datapump_control }}

# The list of known outpost nodes. Subscriptions to these are established
# at start-up. New nodes may also be added dynamically whenever introduced
# through a camera handoff over the control_port. Dynamically added nodes
# are cleared by a restart.
#
# Auto-generated from sentinelcam_outposts registry in group_vars/all/site.yaml
# This datasink ({{ inventory_hostname }}) subscribes to outposts where datasink == '{{ inventory_hostname }}'
# Ports use sentinelcam_ports.imagenode_publisher and imagenode_logging (overridable per view)
outpost_nodes:
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_config.datasink == inventory_hostname %}
{%     set outpost_host = outpost_config.hostname | default(outpost_name) %}
{%     for camera_id, camera_config in outpost_config.cameras.items() %}
{%       set logger_port = camera_config.logger_port | default(sentinelcam_ports.imagenode_logging) %}
{%       set image_port = camera_config.image_port | default(sentinelcam_ports.imagenode_publisher) %}
  {{ outpost_name }}:
    view: {{ camera_config.viewname }}
    logger: tcp://{{ outpost_host }}:{{ logger_port }}
    images: tcp://{{ outpost_host }}:{{ image_port }}
{%     endfor %}
{%   endif %}
{% endfor %}

# Defines camwatcher to sentinel communication channels. The datapump connection
# specified below is provided to the sentinel for DataFeed queries. Must match the
# datapump configuration for this host.
sentinel:
   requests:  tcp://{{ sentinelcam_sentinel }}:{{ sentinelcam_ports.sentinel_control }}
   publisher: tcp://{{ sentinelcam_sentinel }}:{{ sentinelcam_ports.sentinel_logging }}
   datapump:  tcp://{{ inventory_hostname }}:{{ sentinelcam_ports.datapump_control }}
   datasink:  {{ inventory_hostname }}

       ##   Data storage locations  ##
data:
  images:   {{ sentinelcam_directories.images }}
  csvfiles: {{ sentinelcam_directories.csvfiles }}

logconfigs:
    # Internal logging for the camwatcher along with messages from outpost nodes
    camwatcher_internal:
        version: 1
        formatters:
            default:
                format: '%(asctime)s %(levelname)s: %(message)s'
        handlers:
            file:
                class: logging.handlers.TimedRotatingFileHandler
                filename: {{ sentinelcam_directories.logs }}/camwatcher.log
                formatter: default
                when: {{ sentinelcam_logging.rotation.when | default('midnight') }}
                backupCount: {{ sentinelcam_logging.rotation.backup_count_time | default(120) }}
                level: {{ 'DEBUG' if debug_mode else sentinelcam_logging.level | default('INFO') }}
        root:
            handlers: [file]
            level: {{ 'DEBUG' if debug_mode else sentinelcam_logging.level | default('INFO') }}

    # The sentinel does not write to a logfile on disk. All logging activity,
    # including full task results along with internal warnings and errors, are
    # published over 0MQ. A sentinel agent, as a child subprocess, subscribes to
    # this and manages updates to the data sink. Other collected status and logging
    # content will be captured as specified below.
    sentinel_agent:
        version: 1
        formatters:
            default:
                format: '%(asctime)s %(levelname)s: %(message)s'
        handlers:
            file:
                class: logging.handlers.TimedRotatingFileHandler
                filename: {{ sentinelcam_directories.logs }}/sentinel.log
                formatter: default
                when: {{ sentinelcam_logging.rotation.when | default('midnight') }}
                backupCount: {{ sentinelcam_logging.rotation.backup_count_time | default(120) }}
                level: {{ 'DEBUG' if debug_mode else sentinelcam_logging.level | default('INFO') }}
        root:
            handlers: [file]
            level: {{ 'DEBUG' if debug_mode else sentinelcam_logging.level | default('INFO') }}
