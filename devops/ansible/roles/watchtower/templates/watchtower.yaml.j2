%YAML 1.0
---
# Watchtower configuration file
# Generated by Ansible template

socket_dir: {{ watchtower_socket_dir }}
sentinel: {{ watchtower_sentinel }}
default_view: {{ watchtower_default_view }}
viewfps: {{ watchtower_viewfps | lower }}
inactivity_timeout: {{ inactivity_timeout }}

# For ring buffer allocations, any potential image size must be
# known in advance. Parameters are ((width, height), buffer_length)
# Auto-generated from sentinelcam_outposts registry to include all unique resolutions
ring_buffers:
{% set ring_buffers_generated = {} %}
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_name in watchtower_monitored_outposts %}
{%     for camera_id, camera_config in outpost_config.cameras.items() %}
{%       set resolution_key = '%dx%d' | format(camera_config.resolution[0], camera_config.resolution[1]) %}
{%       if resolution_key not in ring_buffers_generated %}
{%         set _ = ring_buffers_generated.update({resolution_key: camera_config.resolution}) %}
  {{ resolution_key }}: (({{ camera_config.resolution[0] }}, {{ camera_config.resolution[1] }}), 5)
{%       endif %}
{%     endfor %}
{%   endif %}
{% endfor %}

# The list of known datapumps - auto-generated from unique datasinks in outpost registry
datapumps:
{% set datasinks_seen = [] %}
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_name in watchtower_monitored_outposts and outpost_config.datasink not in datasinks_seen %}
{%     set datasink_host = hostvars[outpost_config.datasink].ansible_host | default(outpost_config.datasink) %}
{%     set _ = datasinks_seen.append(outpost_config.datasink) %}
  {{ outpost_config.datasink }}: tcp://{{ datasink_host }}:{{ sentinelcam_ports.datapump_control }}
{%   endif %}
{% endfor %}

# Each outpost (node) has an image publisher and an associated datapump.
# Auto-generated from sentinelcam_outposts registry in group_vars/all/site.yaml
# This watchtower monitors: {{ watchtower_monitored_outposts | join(', ') }}
# Ports use sentinelcam_ports.imagenode_publisher (overridable per view)
outposts:
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_name in watchtower_monitored_outposts %}
{%     set outpost_host = hostvars[outpost_name].ansible_host | default(outpost_name) %}
{%     for camera_id, camera_config in outpost_config.cameras.items() %}
{%       set image_port = camera_config.image_port | default(sentinelcam_ports.imagenode_publisher) %}
  {{ outpost_name }}:
    image_publisher: tcp://{{ outpost_host }}:{{ image_port }}
    datapump: {{ outpost_config.datasink }}
{%     endfor %}
{%   endif %}
{% endfor %}

# Every camera view is provided by an outpost node. Note that
# each outpost can potentially support multiple views.
# Auto-generated from sentinelcam_outposts registry
outpost_views:
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_name in watchtower_monitored_outposts %}
{%     for camera_id, camera_config in outpost_config.cameras.items() %}
  {{ camera_config.viewname }}:
    outpost: {{ outpost_name }}
    description: {{ camera_config.description }}
    size: ({{ camera_config.resolution[0] }}, {{ camera_config.resolution[1] }})
{%     endfor %}
{%   endif %}
{% endfor %}

# Video export configuration (optional - if not present, share button will not appear)
# Exports events with tracking overlays as MP4 video files
{% if watchtower_video_export is defined and watchtower_video_export.enabled | default(false) %}
video_export:
  # Output directory on datasink node (requires SSH access configured via ansible)
  output_dir: {{ watchtower_video_export.output_dir | default(primary_datasink ~ ':' ~ sentinelcam_directories.video_archives) }}

  # Maximum gap in seconds between events to consider them sequential for auto-merge
  max_event_gap_seconds: {{ watchtower_video_export.max_event_gap_seconds | default(30) }}

  # Maximum number of events to merge into a single video
  max_merged_events: {{ watchtower_video_export.max_merged_events | default(10) }}

  # Include tracking overlays (bounding boxes, class names) in exported video
  include_overlays: {{ watchtower_video_export.include_overlays | default(true) | lower }}

  # Number of frames to display event header at start of each sub-event
  header_duration_frames: {{ watchtower_video_export.header_duration_frames | default(60) }}

  # Calculate text color based on frame brightness for better readability
  #adaptive_text_color: {{ watchtower_video_export.adaptive_text_color | default(true) | lower }}

  # Local temporary directory for rendering before transfer (must have sufficient space)
  local_temp_dir: {{ watchtower_video_export.local_temp_dir | default('/tmp/watchtower_exports') }}

  # VPS upload configuration (optional - if defined, exports will be uploaded for external sharing)
{% if vault_vps_ssh_host is defined and vault_telegram_bot_token is defined %}
  vps_upload:
    enabled: true
    host: {{ vault_vps_ssh_host }}
    user: {{ vault_vps_ssh_user | default('rocky') }}
    port: {{ vault_vps_ssh_port | default(22) }}
    path: {{ watchtower_video_export.vps_export_path | default('/var/www/sentinelcam_exports') }}
    base_url: {{ watchtower_video_export.vps_base_url | default('https://' ~ vault_vps_ssh_host ~ '/exports') }}
    secure_link_secret: {{ vault_vps_secure_link_secret }}
    link_expiry_hours: {{ watchtower_video_export.link_expiry_hours | default(24) }}

  # site name for labeling uploads
  site_description: {{ sentinelcam_site_location | default('SentinelCam') }}

  # Notification configuration via Telegram
  notifications:
    telegram:
      bot_token: {{ vault_telegram_bot_token }}
      chat_id: {{ vault_telegram_chat_id }}
{% endif %}
{% endif %}
