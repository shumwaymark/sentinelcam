%YAML 1.0
---
# Watchtower configuration file
# Generated by Ansible template

socket_dir: {{ watchtower_socket_dir }}
sentinel: {{ watchtower_sentinel }}
default_view: {{ watchtower_default_view }}
viewfps: {{ watchtower_viewfps | lower }}

# For ring buffer allocations, any potential image size must be
# known in advance. Parameters are ((width, height), buffer_length)
# Auto-generated from sentinelcam_outposts registry to include all unique resolutions
ring_buffers:
{% set ring_buffers_generated = {} %}
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_name in watchtower_monitored_outposts %}
{%     for camera_id, camera_config in outpost_config.cameras.items() %}
{%       set resolution_key = '%dx%d' | format(camera_config.resolution[0], camera_config.resolution[1]) %}
{%       if resolution_key not in ring_buffers_generated %}
{%         set _ = ring_buffers_generated.update({resolution_key: camera_config.resolution}) %}
  {{ resolution_key }}: (({{ camera_config.resolution[0] }}, {{ camera_config.resolution[1] }}), 5)
{%       endif %}
{%     endfor %}
{%   endif %}
{% endfor %}

# The list of known datapumps - auto-generated from unique datasinks in outpost registry
datapumps:
{% set datasinks_seen = [] %}
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_name in watchtower_monitored_outposts and outpost_config.datasink not in datasinks_seen %}
{%     set datasink_host = hostvars[outpost_config.datasink].ansible_host | default(outpost_config.datasink) %}
{%     set _ = datasinks_seen.append(outpost_config.datasink) %}
  {{ outpost_config.datasink }}: tcp://{{ datasink_host }}:{{ sentinelcam_ports.datapump_control }}
{%   endif %}
{% endfor %}

# Each outpost (node) has an image publisher and an associated datapump.
# Auto-generated from sentinelcam_outposts registry in group_vars/all/site.yaml
# This watchtower monitors: {{ watchtower_monitored_outposts | join(', ') }}
# Ports use sentinelcam_ports.imagenode_publisher (overridable per view)
outposts:
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_name in watchtower_monitored_outposts %}
{%     set outpost_host = hostvars[outpost_name].ansible_host | default(outpost_name) %}
{%     for camera_id, camera_config in outpost_config.cameras.items() %}
{%       set image_port = camera_config.image_port | default(sentinelcam_ports.imagenode_publisher) %}
  {{ outpost_name }}:
    image_publisher: tcp://{{ outpost_host }}:{{ image_port }}
    datapump: {{ outpost_config.datasink }}
{%     endfor %}
{%   endif %}
{% endfor %}

# Every camera view is provided by an outpost node. Note that
# each outpost can potentially support multiple views.
# Auto-generated from sentinelcam_outposts registry
outpost_views:
{% for outpost_name, outpost_config in sentinelcam_outposts.items() %}
{%   if outpost_name in watchtower_monitored_outposts %}
{%     for camera_id, camera_config in outpost_config.cameras.items() %}
  {{ camera_config.viewname }}:
    outpost: {{ outpost_name }}
    description: {{ camera_config.description }}
    size: ({{ camera_config.resolution[0] }}, {{ camera_config.resolution[1] }})
{%     endfor %}
{%   endif %}
{% endfor %}
